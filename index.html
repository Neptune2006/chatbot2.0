<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
<meta name="theme-color" content="#000000" id="themeMeta" />
<title>hri</title>

<style>
/* --- üé® THEME ENGINE V5 (ARTIST EDITION) --- */
:root {
  --font: system-ui, -apple-system, sans-serif;
  --shadow: 0 10px 40px -10px rgba(0,0,0,0.5);
  --glass-border: 1px solid rgba(255, 255, 255, 0.12);
  --transition: 0.6s cubic-bezier(0.22, 1, 0.36, 1);
}

/* üåä OCEAN: Bora Bora vs. The Leviathan */
body.ocean { 
  /* Friendly: Tropical Water */
  --bg: linear-gradient(to bottom, #43cea2, #185a9d);
  --glass: rgba(255, 255, 255, 0.2);
  --text: #e0f7fa; --subtext: #b2ebf2;
  --bot-bg: rgba(255, 255, 255, 0.25); --user-bg: #006064; --accent: #00e5ff;
}
body.ocean.evil-mode {
  /* Evil: Bioluminescent Deep */
  --bg: linear-gradient(to bottom, #000000, #001510, #002b1f);
  --glass: rgba(0, 20, 15, 0.85);
  --text: #a7f3d0; --subtext: #065f46;
  --bot-bg: rgba(0, 255, 128, 0.05); --user-bg: #064e3b; --accent: #10b981;
}

/* üåÖ SUNSET: L.A. Skyline vs. Mars */
body.sunset { 
  /* Friendly: Dreamy Pink/Orange */
  --bg: linear-gradient(to top, #fa709a 0%, #fee140 100%);
  --glass: rgba(255, 255, 255, 0.35);
  --text: #fff; --subtext: #ffe4e6;
  --bot-bg: rgba(255, 255, 255, 0.4); --user-bg: #fb7185; --accent: #fff;
}
body.sunset.evil-mode {
  /* Evil: Rusty Mars */
  --bg: linear-gradient(to bottom, #450a0a, #7f1d1d, #260000);
  --glass: rgba(40, 5, 0, 0.85);
  --text: #fca5a5; --subtext: #7f1d1d;
  --bot-bg: rgba(0, 0, 0, 0.4); --user-bg: #991b1b; --accent: #ef4444;
}

/* üìº RETRO: 90s Windbreaker vs. Corrupted VHS */
body.retro { 
  /* Friendly: Teal & Pink Pastel */
  --bg: linear-gradient(120deg, #84fab0 0%, #8fd3f4 100%);
  --glass: rgba(255, 255, 255, 0.4);
  --text: #134e4a; --subtext: #2dd4bf;
  --bot-bg: rgba(255, 255, 255, 0.6); --user-bg: #2dd4bf; --accent: #0d9488;
}
body.retro.evil-mode {
  /* Evil: Dark Static */
  --bg: linear-gradient(to bottom, #232526, #414345);
  --glass: rgba(20, 20, 20, 0.9);
  --text: #a8a29e; --subtext: #57534e;
  --bot-bg: rgba(255, 255, 255, 0.05); --user-bg: #52525b; --accent: #78716c;
}

/* üìü TERMINAL */
body.terminal { --bg: #000; --glass: rgba(0,20,0,0.9); --text: #0f0; --bot-bg: #020; --user-bg: #040; --accent: #0f0; --font: "Courier New", monospace; }
body.terminal.evil-mode { --bg: #1a1000; --glass: rgba(40, 20, 0, 0.95); --text: #ffb000; --subtext: #cc8800; --bot-bg: #332200; --user-bg: #ff9900; --accent: #ffb000; }

/* üëæ CYBERPUNK */
body.cyberpunk { --bg: repeating-linear-gradient(90deg, #050505 0px, #050505 1px, #000 1px, #000 20px); --glass: rgba(10, 10, 10, 0.9); --text: #fcee0a; --subtext: #00f0ff; --bot-bg: #222; --user-bg: #ff003c; --accent: #00f0ff; }
body.cyberpunk.evil-mode { --bg: #000; --glass: rgba(0,0,0,0.95); --text: #ff0000; --subtext: #550000; --bot-bg: #111; --user-bg: #ff0000; --accent: #ff0000; border-left: 5px solid red; }

/* ‚òï COFFEE */
body.coffee { --bg: linear-gradient(to right, #d7ccc8, #a1887f); --glass: rgba(255, 255, 255, 0.3); --text: #3e2723; --subtext: #5d4037; --bot-bg: rgba(255, 255, 255, 0.5); --user-bg: #8d6e63; --accent: #6d4c41; }
body.coffee.evil-mode { --bg: #1a120b; --glass: rgba(26, 18, 11, 0.9); --text: #8a6a5c; --subtext: #5c4033; --bot-bg: rgba(255,255,255,0.05); --user-bg: #3c2a21; --accent: #3c2a21; }

/* üßõ DRACULA */
body.dracula { --bg: linear-gradient(135deg, #282a36 0%, #44475a 100%); --glass: rgba(40, 42, 54, 0.9); --text: #f8f8f2; --subtext: #bd93f9; --bot-bg: #6272a4; --user-bg: #ff79c6; --accent: #bd93f9; }
body.dracula.evil-mode { --bg: radial-gradient(circle, #3a0000 0%, #000000 100%); --glass: rgba(20, 0, 0, 0.9); --text: #ff0000; --user-bg: #8a0000; --accent: #ff0000; }

/* üå≤ FOREST */
body.forest { --bg: linear-gradient(to top, #134e5e, #71b280); --glass: rgba(19, 78, 94, 0.7); --text: #ecfdf5; --subtext: #a7f3d0; --bot-bg: rgba(255, 255, 255, 0.15); --user-bg: #059669; --accent: #34d399; }
body.forest.evil-mode { --bg: linear-gradient(to bottom, #000000, #0f2027); --glass: rgba(0, 10, 10, 0.9); --text: #5c6b63; --user-bg: #1a2f26; --accent: #2f4f4f; }

/* ü¶Ñ PASTEL */
body.pastel { --bg: linear-gradient(120deg, #e0c3fc 0%, #8ec5fc 100%); --glass: rgba(255, 255, 255, 0.5); --text: #475569; --subtext: #64748b; --bot-bg: rgba(255, 255, 255, 0.6); --user-bg: #a8a4e6; --accent: #c4b5fd; }
body.pastel.evil-mode { --bg: linear-gradient(120deg, #434343 0%, #000000 100%); --glass: rgba(50, 50, 50, 0.8); --text: #a8a8a8; --user-bg: #666; --accent: #666; }

/* üîÆ NEON */
body.neon { --bg: radial-gradient(circle at 50% 50%, #240046, #10002b); --glass: rgba(16, 0, 43, 0.8); --text: #e0aaff; --subtext: #9d4edd; --bot-bg: rgba(60, 9, 108, 0.4); --user-bg: #7b2cbf; --accent: #e0aaff; }
body.neon.evil-mode { --bg: #000; --glass: rgba(0,0,0,0.9); --text: #33ff00; --user-bg: #003300; --accent: #33ff00; }

/* üìÑ WHITE & DARK */
body.white { --bg: #f8fafc; --glass: rgba(255,255,255,0.95); --text: #0f172a; --bot-bg: #e2e8f0; --user-bg: #3b82f6; --accent: #3b82f6; }
body.white.evil-mode { --bg: #a8a29e; --glass: rgba(255,255,255,0.5); --text: #44403c; --user-bg: #57534e; --accent: #78716c; }
body.dark { --bg: #000000; --glass: rgba(18,18,18,0.9); --text: #e5e5e5; --bot-bg: #1f1f1f; --user-bg: #2563eb; --accent: #2563eb; }
body.dark.evil-mode { --bg: #000; --glass: rgba(5,5,5,0.95); --text: #333; --user-bg: #222; --accent: #111; }

/* --- GLOBAL LAYOUT --- */
* { box-sizing: border-box; font-family: var(--font); -webkit-tap-highlight-color: transparent; transition: all 0.6s cubic-bezier(0.22, 1, 0.36, 1); }
body { margin: 0; height: 100dvh; display: flex; background: var(--bg); background-size: 400% 400%; animation: gradientBG 20s ease infinite; color: var(--text); overflow: hidden; }

@keyframes gradientBG { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }

/* SIDEBAR: Glass */
.sidebar {
  width: 260px; 
  background: var(--glass); 
  backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px);
  border-right: var(--glass-border);
  display: flex; flex-direction: column; padding: 20px; flex-shrink: 0;
  transition: transform 0.3s ease;
  z-index: 100;
}
.brand { font-size: 1.6rem; font-weight: 800; margin-bottom: 25px; color: var(--accent); letter-spacing: -1px; display: flex; justify-content: space-between; align-items: center; text-shadow: 0 0 20px rgba(0,0,0,0.1); }

/* ‚ú® AESTHETIC BUTTONS ‚ú® */
.btn-new { 
  width: 100%; padding: 14px; border: none; border-radius: 16px; 
  background: linear-gradient(135deg, var(--accent), #fff); 
  background-size: 200% 200%;
  color: #000; font-weight: 700; cursor: pointer; margin-bottom: 20px; 
  box-shadow: 0 4px 15px rgba(0,0,0,0.1); 
  transition: transform 0.2s, box-shadow 0.2s; 
  opacity: 0.9;
}
.btn-new:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0,0,0,0.2); opacity: 1; }
.btn-new:active { transform: scale(0.97); }

.history-list { flex: 1; overflow-y: auto; }
.chat-item { padding: 12px; margin-bottom: 8px; border-radius: 12px; cursor: pointer; color: var(--subtext); font-size: 0.95rem; display: flex; justify-content: space-between; align-items: center; transition: 0.2s; }
.chat-item:hover { background: rgba(255,255,255,0.1); color: var(--text); }
.chat-item.active { background: rgba(255,255,255,0.2); color: var(--text); font-weight: 600; border: 1px solid var(--border); box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
.icon-btn { background: none; border: none; cursor: pointer; font-size: 1.1rem; padding: 4px; color: var(--text); opacity: 0.6; transition: 0.2s; }
.icon-btn:hover { opacity: 1; transform: scale(1.1); }

/* MAIN */
.main { flex: 1; display: flex; flex-direction: column; position: relative; width: 100%; height: 100%; }

.header { 
  padding: 10px 20px; 
  background: var(--glass); 
  backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px);
  border-bottom: var(--glass-border);
  display: flex; justify-content: space-between; align-items: center; height: 70px; flex-shrink: 0; 
}
.header-left { display: flex; align-items: center; gap: 15px; overflow: hidden; }
.menu-btn { display: none; background: none; border: none; font-size: 1.5rem; color: var(--text); cursor: pointer; padding: 0; }
.header-controls { display: flex; gap: 10px; align-items: center; }

/* CONTROLS */
select, .btn-small { 
  padding: 8px 12px; border-radius: 12px; 
  border: 1px solid rgba(255,255,255,0.15); 
  background: rgba(255,255,255,0.1); color: var(--text); outline: none; font-size: 0.9rem; 
  backdrop-filter: blur(10px); cursor: pointer; 
  transition: 0.2s;
}
select:hover, .btn-small:hover { background: rgba(255,255,255,0.2); transform: translateY(-1px); }

.mode-btn { 
  padding: 8px 12px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.15); 
  background: rgba(255,255,255,0.1); cursor: pointer; font-size: 1.2rem; transition: 0.3s; 
}
.mode-btn:hover { background: rgba(255,255,255,0.2); transform: scale(1.05); }

.messages { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 16px; scroll-behavior: smooth; }
.msg { max-width: 80%; padding: 14px 20px; border-radius: 22px; line-height: 1.6; font-size: 1rem; word-wrap: break-word; box-shadow: 0 2px 10px rgba(0,0,0,0.05); position: relative; }
.msg.bot { background: var(--bot-bg); color: var(--text); align-self: flex-start; border-bottom-left-radius: 4px; border: 1px solid rgba(255,255,255,0.1); backdrop-filter: blur(5px); }
.msg.user { background: var(--user-bg); color: #fff; align-self: flex-end; border-bottom-right-radius: 4px; border: 1px solid rgba(255,255,255,0.2); }
.msg.error { background: #ef4444; color: white; align-self: center; font-size: 0.85rem; }

/* INPUT */
.input-area { 
  padding: 20px; 
  background: var(--glass); 
  backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px);
  border-top: var(--glass-border);
  display: flex; gap: 12px; align-items: center; flex-shrink: 0; 
  padding-bottom: max(20px, env(safe-area-inset-bottom)); 
}
input { 
  flex: 1; padding: 14px 20px; border-radius: 30px; 
  border: 1px solid rgba(255,255,255,0.15); 
  background: rgba(255,255,255,0.05); color: var(--text); outline: none; font-size: 16px; 
  transition: 0.3s; box-shadow: inset 0 2px 5px rgba(0,0,0,0.05); 
}
input:focus { background: rgba(255,255,255,0.15); border-color: var(--accent); transform: scale(1.01); }

.send-btn { 
  width: 50px; height: 50px; border-radius: 50%; border: none; 
  background: linear-gradient(135deg, var(--accent), #fff); 
  color: #000; cursor: pointer; display: flex; align-items: center; justify-content: center; 
  font-size: 1.3rem; flex-shrink: 0; box-shadow: 0 4px 15px rgba(0,0,0,0.3); 
  transition: transform 0.2s; opacity: 0.9;
}
.send-btn:active { transform: scale(0.9); }

@media (max-width: 768px) {
  .menu-btn { display: block; } .sidebar { position: fixed; top: 0; left: 0; height: 100%; width: 280px; transform: translateX(-100%); box-shadow: 10px 0 40px rgba(0,0,0,0.5); } .sidebar.open { transform: translateX(0); } .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 90; display: none; backdrop-filter: blur(8px); } .overlay.active { display: block; } .header-controls select { max-width: 80px; } 
}
::-webkit-scrollbar { width: 4px; } ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 2px; }
</style>
</head>
<body>

<div class="overlay" onclick="toggleSidebar()"></div>

<div class="sidebar" id="sidebar">
  <div class="brand">hri ‚ö° <button class="icon-btn" onclick="toggleSidebar()" style="display:none;" id="closeSidebar">‚úï</button></div>
  <button class="btn-new" onclick="newChat()">+ New Chat</button>
  <div class="history-list" id="chatList"></div>
  <div style="font-size:11px; color:var(--subtext); text-align:center; margin-top:auto;" id="model-status">Starting...</div>
</div>

<div class="main">
  <div class="header">
    <div class="header-left">
      <button class="menu-btn" onclick="toggleSidebar()">‚ò∞</button>
      <span id="chatTitle" onclick="renameCurrentChat()" style="font-weight:700; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width: 150px; cursor:pointer;">New Chat</span>
      <button class="icon-btn" onclick="renameCurrentChat()" style="margin-left:5px; opacity:0.6;">‚úèÔ∏è</button>
    </div>
    <div class="header-controls">
      <button class="mode-btn" id="modeBtn" onclick="toggleMode()">üòá</button>
      <select id="themeSelector" onchange="setTheme(this.value)">
        <option value="ocean">Ocean</option>
        <option value="sunset">Sunset</option>
        <option value="retro">Retro</option>
        <option value="dracula">Dracula</option>
        <option value="terminal">Terminal</option>
        <option value="dark">Dark</option>
        <option value="coffee">Coffee</option>
        <option value="forest">Forest</option>
        <option value="pastel">Pastel</option>
        <option value="neon">Neon</option>
        <option value="cyberpunk">Cyber</option>
        <option value="white">White</option>
      </select>
      <button class="btn-small" onclick="exportChat()">üì•</button><button class="btn-small" onclick="clearAll()" style="color:#ef4444;">üóëÔ∏è</button>
    </div>
  </div>

  <div class="messages" id="messages"></div>

  <div class="input-area">
    <input id="input" placeholder="Message..." autocomplete="off" onkeypress="if(event.key==='Enter') send()" />
    <button class="send-btn" onclick="send()">‚û§</button>
  </div>
</div>

<script>window.onerror=function(e,s,l){alert("‚ö†Ô∏è CRASHED: "+e+"\nLine: "+l);}</script>

<script>
/* -------------------------------------------------------------------------
   üõ°Ô∏è MULTI-KEY ROTATOR
   ------------------------------------------------------------------------- */
const REVERSED_KEYS = [
  "UChJp6s_krI25KUESjbZt_weKh70cgOlCySazIA", 
  "UiGWQA-VScFJnzbR-hyeQfkZvEejAivyAySazIA",
  "EhHtSx2K1gD4jDXhRGjdJJgbnqEw6FzKBySazIA"
];

// Un-reverse all keys into a usable list
const API_KEYS = REVERSED_KEYS.map(k => k.split('').reverse().join(''));
let currentKeyIndex = 0;

/* --- AUTO-DISCOVERY --- */
let ACTIVE_MODEL = "";
async function findWorkingModel() {
  const status = document.getElementById("model-status");
  status.innerText = `üîç Checking Key ${currentKeyIndex + 1}...`;
  
  if(API_KEYS.length === 0 || API_KEYS[0].includes("REVERSED_KEY")) {
    status.innerText = "‚ùå No Keys"; status.style.color = "red";
    alert("STOP! You need to paste your reversed keys in the code.");
    return;
  }

  for (let i = 0; i < API_KEYS.length; i++) {
    try {
      const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${API_KEYS[i]}`);
      const data = await res.json();
      if (data.models) {
        currentKeyIndex = i;
        const models = data.models.map(m => m.name.replace("models/", ""));
        ACTIVE_MODEL = models.find(m => m.includes("flash")) || models[0];
        status.innerText = `üü¢ Key ${i+1}: Online`; status.style.color = "#4ade80";
        return;
      }
    } catch (e) { console.log(`Key ${i+1} failed check.`); }
  }
  status.innerText = "üî¥ All Keys Dead"; status.style.color = "#ef4444";
}

/* --- STATE & MODES --- */
let chats = JSON.parse(localStorage.getItem("hri_chats_v2")) || {};
let currentChatId = localStorage.getItem("hri_current_id");
let isAngryMode = false; 

if (!currentChatId || !chats[currentChatId]) newChat(); else loadChat(currentChatId);
setTheme(localStorage.getItem("hri_theme") || "ocean");
document.getElementById("themeSelector").value = localStorage.getItem("hri_theme") || "ocean";
findWorkingModel();

/* --- UTILS --- */
function toggleSidebar() { const s=document.getElementById("sidebar"); const o=document.querySelector(".overlay"); const c=document.getElementById("closeSidebar"); s.classList.toggle("open"); o.classList.toggle("active"); if(window.innerWidth<=768)c.style.display=s.classList.contains("open")?"block":"none"; }
function mobileLoadChat(id) { loadChat(id); if(window.innerWidth<=768) toggleSidebar(); }
function save() { localStorage.setItem("hri_chats_v2", JSON.stringify(chats)); localStorage.setItem("hri_current_id", currentChatId); }

function setTheme(t) { 
  document.body.className = t + (isAngryMode ? " evil-mode" : "");
  localStorage.setItem("hri_theme", t); 
  const m=document.getElementById("themeMeta");
  const colors = { ocean: "#4facfe", sunset: "#fa709a", retro: "#84fab0", dark: "#000" };
  if(m && colors[t]) m.content = colors[t];
}

function toggleMode() {
  isAngryMode = !isAngryMode;
  const btn = document.getElementById("modeBtn");
  if(isAngryMode) {
    btn.innerText = "üòà"; btn.style.background = "rgba(255,0,0,0.2)"; btn.style.color = "red"; btn.style.borderColor = "red";
    document.body.classList.add("evil-mode");
    addBubble("<i>Switched to ANGRY mode.</i>", "bot");
  } else {
    btn.innerText = "üòá"; btn.style.background = "rgba(255,255,255,0.1)"; btn.style.color = "var(--text)"; btn.style.borderColor = "rgba(255,255,255,0.1)";
    document.body.classList.remove("evil-mode");
    addBubble("<i>Switched back to Friendly mode.</i>", "bot");
  }
}

function newChat() { const id = "chat_" + Date.now(); chats[id] = { title: "New Chat", history: [] }; loadChat(id); if(window.innerWidth <= 768 && document.getElementById("sidebar").classList.contains("open")) toggleSidebar(); }
function loadChat(id) { currentChatId = id; const chat = chats[id]; document.getElementById("messages").innerHTML = ""; document.getElementById("chatTitle").innerText = chat.title; chat.history.forEach(m => addBubble(m.text, m.from)); renderSidebar(); save(); }
function renderSidebar() { const l = document.getElementById("chatList"); l.innerHTML = ""; Object.keys(chats).sort().reverse().forEach(id => { const div = document.createElement("div"); div.className = `chat-item ${id === currentChatId ? 'active' : ''}`; div.innerHTML = `<span onclick="mobileLoadChat('${id}')" style="flex:1; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${chats[id].title}</span><div class="chat-actions"><button class="icon-btn" onclick="deleteChat('${id}')">üóëÔ∏è</button></div>`; l.appendChild(div); }); }
function addBubble(text, from) { const d = document.createElement("div"); d.className = `msg ${from}`; d.innerHTML = text.replace(/\n/g, "<br>"); const b = document.getElementById("messages"); b.appendChild(d); b.scrollTop = b.scrollHeight; }
function deleteChat(id) { if(!confirm("Delete?"))return; delete chats[id]; const r=Object.keys(chats); if(r.length===0)newChat(); else loadChat(r[0]); }
function clearAll() { if(confirm("Delete ALL?")) { localStorage.removeItem("hri_chats_v2"); location.reload(); } }
function exportChat() { const c=chats[currentChatId]; let t=`Chat: ${c.title}\n\n`; c.history.forEach(m=>t+=`[${m.from.toUpperCase()}]: ${m.text}\n`); const a=document.createElement("a"); a.href=URL.createObjectURL(new Blob([t],{type:"text/plain"})); a.download=`hri_chat.txt`; a.click(); }
function renameCurrentChat() { const n = prompt("Rename chat:", chats[currentChatId].title); if (n && n.trim()) { chats[currentChatId].title = n.trim(); document.getElementById("chatTitle").innerText = n.trim(); renderSidebar(); save(); } }

async function generateAutoTitle(chatId) {
  const chat = chats[chatId]; if (!chat || chat.history.length < 2) return; 
  const prompt = `Read this chat. Return ONLY a 3-word title. No list. No quotes. No "Here is a title". Just the words.\n\n${chat.history.map(m => m.text).join(" ")}`;
  try {
    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${ACTIVE_MODEL}:generateContent?key=${API_KEYS[currentKeyIndex]}`, {
      method: "POST", headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
    });
    const data = await res.json();
    if (!data.error) {
      const t = data.candidates[0].content.parts[0].text.replace(/['"]/g, "").trim();
      chats[chatId].title = t; if (currentChatId === chatId) document.getElementById("chatTitle").innerText = t; renderSidebar(); save();
    }
  } catch (e) {}
}

/* --- SEND LOGIC --- */
async function send() {
  const input = document.getElementById("input"); const text = input.value.trim(); if (!text) return;
  if (!ACTIVE_MODEL) await findWorkingModel();
  input.value = ""; chats[currentChatId].history.push({ from: "user", text: text }); addBubble(text, "user");
  if (chats[currentChatId].history.length === 1) { chats[currentChatId].title = text.substring(0, 15) + "..."; renderSidebar(); document.getElementById("chatTitle").innerText = chats[currentChatId].title; } save();
  const loadingId = "l_" + Date.now(); const loading = document.createElement("div"); loading.className = "msg bot"; loading.id = loadingId; loading.innerText = "..."; document.getElementById("messages").appendChild(loading);
  
  await attemptSend(loadingId, 0);
}

async function attemptSend(loadingId, retryCount) {
  const history = chats[currentChatId].history.map(m => ({ role: m.from === "user" ? "user" : "model", parts: [{ text: m.text }] }));
  if(history.length > 0 && history[0].role === "model") history.shift();

  const systemPrompt = isAngryMode 
    ? "Your name is hri. You are currently in ANGRY mode. You are rude, aggressive, and you swear/cuss at the user. You roast them hard. Do not apologize." 
    : "Your name is hri. Chill, helpful AI. Adapt tone to user. Concise.";

  try {
    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${ACTIVE_MODEL}:generateContent?key=${API_KEYS[currentKeyIndex]}`, {
      method: "POST", headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        contents: history,
        systemInstruction: { parts: [{ text: systemPrompt }] },
        safetySettings: [ { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_NONE" }, { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_NONE" }, { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_NONE" }, { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_NONE" } ]
      })
    });
    const data = await res.json();

    if (data.error) {
      if (data.error.message.includes("429") || data.error.message.includes("quota")) {
        if (API_KEYS.length > 1) {
          currentKeyIndex = (currentKeyIndex + 1) % API_KEYS.length;
          document.getElementById(loadingId).innerText = `Switching to Key ${currentKeyIndex + 1}...`;
          await new Promise(r => setTimeout(r, 1000)); 
          await attemptSend(loadingId, retryCount); 
          return;
        }
      }
      document.getElementById(loadingId).remove();
      addBubble("‚ö†Ô∏è Error: " + data.error.message, "error");
    } else {
      document.getElementById(loadingId).remove();
      const aiText = data.candidates[0].content.parts[0].text;
      chats[currentChatId].history.push({ from: "bot", text: aiText });
      addBubble(aiText, "bot"); save();
      if (chats[currentChatId].history.length === 2) generateAutoTitle(currentChatId);
    }
  } catch (e) { if(document.getElementById(loadingId))document.getElementById(loadingId).remove(); addBubble("‚ö†Ô∏è Network Error", "error"); }
}
</script>
</body>
</html>
